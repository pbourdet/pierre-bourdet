version: 2.1

defaults: &defaults
    working_directory: ~/pbourdet
    docker:
        - image: cimg/base:stable

filter_merge: &filter_merge
    filters:
        branches:
            ignore:
                - master

only_master: &only_master
    filters:
        branches:
            only:
                - master

commands:
    tests:
        steps:
            - setup_remote_docker:
                  version: 20.10.7
            - run:
                  name: Run tests
                  command: |
                      chmod 755 .circleci/tests.sh
                      ./.circleci/tests.sh

    install_compose:
        steps:
            - run:
                  name: Install Docker Compose
                  command: |
                      apk add docker-compose
    deploy:
        steps:
            - setup_remote_docker:
                  version: 20.10.7
            - run:
                  name: Production deploy
                  command: |
                      chmod 755 .circleci/deploy.sh
                      ./.circleci/deploy.sh

jobs:
    check_pr:
        <<: *defaults
        steps:
            - checkout
            - tests


    deploy_prod:
        working_directory: ~/pbourdet
        docker:
            - image: google/cloud-sdk:alpine
        steps:
            - checkout
            - install_compose
            - deploy

workflows:
    version: 2
    check:
        jobs:
            - check_pr:
                  <<: *filter_merge

    deploy:
        jobs:
            - deploy_prod:
                  <<: *only_master
