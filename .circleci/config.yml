version: 2.1

defaults: &defaults
    working_directory: ~/pbourdet
    docker:
        - image: cimg/base:stable

filter_merge: &filter_merge
    filters:
        branches:
            ignore:
                - master

only_master: &only_master
    filters:
        branches:
            only:
                - master

commands:
    install:
        steps:
            - setup_remote_docker:
                  version: 20.10.7
            - run:
                  name: Start containers
                  command: |
                      docker-compose -f docker-compose-test.yaml up -d
                      docker-compose exec symfony composer install

    migrations:
        steps:
            - run:
                  name: Launch migrations
                  command: docker-compose exec symfony make migrations

    phpunit:
        steps:
            - run:
                  name: Run PHPUnit tests
                  command: docker-compose exec symfony make test

    jest:
        steps:
            - run:
                name: Run Jest tests
                command: docker-compose exec react yarn test src/ --watchAll=false

    lint:
        steps:
            - run:
                  name: PHP CS Fixer
                  command: docker-compose exec symfony ./vendor/bin/php-cs-fixer fix --config=.php-cs-fixer.dist.php -v --dry-run --stop-on-violation --using-cache=no
            - run:
                  name: Yaml lint
                  command: docker-compose exec symfony make yamlint
            - run:
                  name: JS lint
                  command: docker-compose exec react yarn eslint-fix

    phpstan:
        steps:
            - run:
                  name: Run PHPStan
                  command: docker-compose exec symfony make phpstan

    deploy:
        steps:
            - run:
                  name: Production deploy
                  command: |
                      chmod 755 .circleci/deploy.sh
                      ./.circleci/deploy.sh

jobs:
    check_pr:
        <<: *defaults
        steps:
            - checkout
            - install
            - lint
            - phpstan
            - jest
            - migrations
            - phpunit

    deploy_prod:
        working_directory: ~/pbourdet
        docker:
            -   image: circleci/php:8.0-node
        steps:
            - add_ssh_keys:
                fingerprint:
                    - "4c:67:6d:e8:f3:63:47:d5:cb:91:c4:f4:e3:90:ed:d4"
            - checkout
            - deploy

workflows:
    version: 2
    check:
        jobs:
            - check_pr:
                  <<: *filter_merge

    deploy:
        jobs:
            - deploy_prod:
                  <<: *only_master
